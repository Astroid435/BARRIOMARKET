{% load static %}

<div class="orders-grid">
    {% for compra in lista_compras %}
    <div class="order-card">
        <p class="order-date">{{ compra.Fecha|date:"d/m/Y H:i" }}</p>
        <p class="order-price"><span class="fw-semibold">Total:</span> ${{ compra.Valor }}</p>
        <p class="order-products"><span class="fw-semibold">{{ compra.CantidadEncargo.count }}</span> productos</p>

        <!-- Botones -->
        <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#modalCompra{{ compra.id }}">
            Abrir
        </button>
        <button class="btn btn-danger delete-btn" data-id="{{ compra.id }}">
            Eliminar
        </button>
    </div>

    <!-- Modal Detalles de la Compra -->
    <div class="modal fade" id="modalCompra{{ compra.id }}" tabindex="-1" aria-labelledby="modalLabel{{ compra.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content rounded-4">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel{{ compra.id }}">Compra #{{ compra.id }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p><span class="fw-semibold">Administrador:</span> {{ compra.Usuario.Primer_nombre }} {{ compra.Usuario.Primer_apellido }}</p>
                    <p><span class="fw-semibold">Correo:</span> {{ compra.Usuario.Correo }}</p>
                    <p><span class="fw-semibold">Fecha:</span> {{ compra.Fecha|date:"d/m/Y H:i" }}</p>
                    <p><span class="fw-semibold">Total:</span> ${{ compra.Valor }}</p>
                    <hr>
                    <h6 class="fw-semibold">Productos:</h6>
                    <ul>
                        {% for detalle in compra.CantidadEncargo.all %}
                            <li class="detalle-producto"
                                data-nombre="{{ detalle.Productos.Nombre }}"
                                data-cantidad="{{ detalle.Cantidad }}">
                                <span class="fw-semibold">{{ detalle.Productos.Nombre }}</span><br>
                                <em>{{ detalle.Productos.Descripcion }}</em><br>
                                Valor unitario: ${{ detalle.Productos.ValorVenta }}  
                                (Cantidad: {{ detalle.Cantidad }})
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <p>No hay compras registradas.</p>
    {% endfor %}
</div>

<!-- Total general -->
<div class="mt-3 text-end">
    <h5>Total General: <span id="total-general">${{ total_general|floatformat:2 }}</span></h5>
</div>

<!-- Estad√≠sticas -->
<div class="mt-4">
    <h6 class="fw-semibold"> Estad√≠sticas:</h6>
    {% if mas_comprado and menos_comprado %}
        <p><span class="fw-semibold">Producto m√°s comprado:</span> 
           {{ mas_comprado.Productos__Nombre }} ({{ mas_comprado.total_cantidad }})</p>
        <p><span class="fw-semibold">Producto menos comprado:</span> 
           {{ menos_comprado.Productos__Nombre }} ({{ menos_comprado.total_cantidad }})</p>
    {% else %}
        <p>No hay datos suficientes para mostrar estad√≠sticas.</p>
    {% endif %}
</div>
<!-- Script -->
<script>
document.addEventListener('DOMContentLoaded', () => {

    // üîπ Calcular total general
    function recalcularTotalGeneral() {
    let total = 0;
    document.querySelectorAll('.order-price').forEach(el => {
        const match = el.textContent.match(/\$([\d,\.]+)/);
        if (match) {
            const valor = parseFloat(match[1].replace(/,/g, ''));
            if (!isNaN(valor)) {
                total += valor;
            }
        }
    });
    document.getElementById('total-general').textContent = '$' + total.toLocaleString('es-CO');

    
}


    recalcularTotalGeneral();

    // üîπ Eliminar compra con confirmaci√≥n
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            if (confirm("¬øSeguro que deseas eliminar esta compra?")) {
                const card = btn.closest('.order-card');
                if (card) {
                    card.remove();
                    recalcularTotalGeneral();
                }
                // Aqu√≠ podr√≠as hacer fetch/axios al backend para borrar en DB
            }
        });
    });

    // üîπ Calcular producto m√°s y menos comprado
    let productos = {};

    document.querySelectorAll('.detalle-producto').forEach(el => {
        const nombre = el.dataset.nombre;
        const cantidad = parseInt(el.dataset.cantidad);
        if (!productos[nombre]) {
            productos[nombre] = 0;
        }
        productos[nombre] += cantidad;
    });

    let masComprado = null;
    let menosComprado = null;
    let maxCantidad = -Infinity;
    let minCantidad = Infinity;

    for (const [nombre, cantidad] of Object.entries(productos)) {
        if (cantidad > maxCantidad) {
            maxCantidad = cantidad;
            masComprado = { nombre, cantidad };
        }
        if (cantidad < minCantidad) {
            minCantidad = cantidad;
            menosComprado = { nombre, cantidad };
        }
    }

    if (masComprado && menosComprado) {
        document.getElementById('producto-mas').textContent = `${masComprado.nombre} (${masComprado.cantidad})`;
        document.getElementById('producto-menos').textContent = `${menosComprado.nombre} (${menosComprado.cantidad})`;
    }

});
</script>
